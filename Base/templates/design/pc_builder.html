{% load static humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC Builder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/ui.css' %}">
</head>
<body>
<div class="page">
    <div class="app-shell">
        <aside class="sidebar">
            <div class="brand">Inventory+</div>
            <div class="profile-card">
                {% if user.profile.profile_picture %}
                    <img src="{{ user.profile.profile_picture.url }}" alt="Profile" class="avatar">
                {% else %}
                    <div class="avatar">{{ user.first_name|first|default:user.username|first|upper }}</div>
                {% endif %}
                <div class="profile-meta">
                    <h3>{% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}</h3>
                    <p title="{{ user.email|default:'No email' }}">{{ user.email|default:"No email" }}</p>
                </div>
            </div>
            <ul class="nav-list">
                <li><a href="{% url 'landing' %}">Dashboard <span>&rsaquo;</span></a></li>
                <li><a href="{% url 'product' %}">Product Management <span>&rsaquo;</span></a></li>
                <li><a href="{% url 'category' %}">Masterlist <span>&rsaquo;</span></a></li>
                <li><a class="active" href="{% url 'pc-builder' %}">Price Quote <span>&rsaquo;</span></a></li>
                <li><a href="{% url 'checkout-history' %}">Checkout History <span>&rsaquo;</span></a></li>
                <li><a href="{% url 'profile-settings' %}">Profile Settings <span>&rsaquo;</span></a></li>
                <li><a href="{% url 'logout' %}">Log out <span>&rsaquo;</span></a></li>
            </ul>
        </aside>

        <main class="main-panel">
        <section class="topbar builder-topbar">
            <div class="actions">
                <a href="{% url 'landing' %}" class="btn btn-ghost">Back to Home</a>
                <a href="{% url 'checkout-history' %}" class="btn btn-ghost">Checkout History</a>
            </div>
            <h1 style="margin-top: 14px;">PC Builder</h1>
            <p>Create a quote by selecting parts and quantities by category.</p>
        </section>

        {% if prefill_notes %}
        <section class="alerts">
            {% for note in prefill_notes %}
            <div class="alert error">{{ note }}</div>
            {% endfor %}
        </section>
        {% endif %}

        <section class="card builder-card">
            <form method="post" action="{% url 'checkout_pc_build' %}" class="builder-form">
                {% csrf_token %}
                <input type="hidden" name="build_items" id="build-items-input" value="[]">

                <div class="forms-grid">
                    <label class="builder-label">Choose RAM</label>
                    <div class="part-container" data-type="ram">
                        <div class="part-row">
                            <select class="part-select" onchange="handleSelect(this)">
                                <option value="0">-- Select RAM --</option>
                                {% for p in ram %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-stock="{{ p.quantity }}" {% if p.quantity <= 0 %}disabled{% endif %}>
                                    {{ p.name }} (PHP {{ p.price|floatformat:2|intcomma }}){% if p.quantity <= 0 %} - Out of stock{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" class="part-qty" min="1" value="1" disabled onchange="calculateTotal()">
                        </div>
                    </div>

                    <label class="builder-label">Choose Motherboard</label>
                    <div class="part-container" data-type="motherboard">
                        <div class="part-row">
                            <select class="part-select" onchange="handleSelect(this)">
                                <option value="0">-- Select Motherboard --</option>
                                {% for p in motherboard %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-stock="{{ p.quantity }}" {% if p.quantity <= 0 %}disabled{% endif %}>
                                    {{ p.name }} (PHP {{ p.price|floatformat:2|intcomma }}){% if p.quantity <= 0 %} - Out of stock{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" class="part-qty" min="1" value="1" disabled onchange="calculateTotal()">
                        </div>
                    </div>

                    <label class="builder-label">Choose CPU</label>
                    <div class="part-container" data-type="cpu">
                        <div class="part-row">
                            <select class="part-select" onchange="handleSelect(this)">
                                <option value="0">-- Select CPU --</option>
                                {% for p in cpu %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-stock="{{ p.quantity }}" {% if p.quantity <= 0 %}disabled{% endif %}>
                                    {{ p.name }} (PHP {{ p.price|floatformat:2|intcomma }}){% if p.quantity <= 0 %} - Out of stock{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" class="part-qty" min="1" value="1" disabled onchange="calculateTotal()">
                        </div>
                    </div>

                    <label class="builder-label">Choose GPU</label>
                    <div class="part-container" data-type="gpu">
                        <div class="part-row">
                            <select class="part-select" onchange="handleSelect(this)">
                                <option value="0">-- Select GPU --</option>
                                {% for p in gpu %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-stock="{{ p.quantity }}" {% if p.quantity <= 0 %}disabled{% endif %}>
                                    {{ p.name }} (PHP {{ p.price|floatformat:2|intcomma }}){% if p.quantity <= 0 %} - Out of stock{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" class="part-qty" min="1" value="1" disabled onchange="calculateTotal()">
                        </div>
                    </div>

                    <label class="builder-label">Choose Storage</label>
                    <div class="part-container" data-type="storage">
                        <div class="part-row">
                            <select class="part-select" onchange="handleSelect(this)">
                                <option value="0">-- Select Storage --</option>
                                {% for p in storage %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-stock="{{ p.quantity }}" {% if p.quantity <= 0 %}disabled{% endif %}>
                                    {{ p.name }} (PHP {{ p.price|floatformat:2|intcomma }}){% if p.quantity <= 0 %} - Out of stock{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" class="part-qty" min="1" value="1" disabled onchange="calculateTotal()">
                        </div>
                    </div>

                    <label class="builder-label">Choose PSU</label>
                    <div class="part-container" data-type="psu">
                        <div class="part-row">
                            <select class="part-select" onchange="handleSelect(this)">
                                <option value="0">-- Select PSU --</option>
                                {% for p in psu %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-stock="{{ p.quantity }}" {% if p.quantity <= 0 %}disabled{% endif %}>
                                    {{ p.name }} (PHP {{ p.price|floatformat:2|intcomma }}){% if p.quantity <= 0 %} - Out of stock{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" class="part-qty" min="1" value="1" disabled onchange="calculateTotal()">
                        </div>
                    </div>

                    <label class="builder-label">Choose Case</label>
                    <div class="part-container" data-type="case">
                        <div class="part-row">
                            <select class="part-select" onchange="handleSelect(this)">
                                <option value="0">-- Select Case --</option>
                                {% for p in case %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-stock="{{ p.quantity }}" {% if p.quantity <= 0 %}disabled{% endif %}>
                                    {{ p.name }} (PHP {{ p.price|floatformat:2|intcomma }}){% if p.quantity <= 0 %} - Out of stock{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" class="part-qty" min="1" value="1" disabled onchange="calculateTotal()">
                        </div>
                    </div>
                </div>

                <div class="builder-summary">
                    <h2 class="builder-total-title">Total Price</h2>
                    <p class="builder-total-amount">PHP <span id="total">0.00</span></p>
                </div>
                <div class="actions">
                    <button type="submit" class="btn btn-success checkout-btn">Checkout Build</button>
                    {% if show_reorder_cancel %}
                    <a href="{% if prefill_cancel_url %}{{ prefill_cancel_url }}{% else %}{% url 'checkout-history' %}{% endif %}" class="btn btn-danger checkout-btn">Cancel Reorder</a>
                    {% endif %}
                </div>
            </form>
        </section>
        </main>
    </div>
</div>

<script>
const prefillBuildItems = JSON.parse('{{ prefill_build_items_json|escapejs }}');

function handleSelect(selectElement) {
    const row = selectElement.closest(".part-row");
    const qtyInput = row.querySelector(".part-qty");
    const container = selectElement.closest(".part-container");
    const rows = container.querySelectorAll(".part-row");

    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const stock = parseInt(selectedOption.dataset.stock || 0, 10);

    if (selectElement.value !== "0") {
        qtyInput.disabled = false;
        qtyInput.max = stock;

        if (stock <= 0) {
            qtyInput.value = 0;
            qtyInput.disabled = true;
        } else {
            qtyInput.value = 1;
        }

        if (row === rows[rows.length - 1]) {
            const newRow = row.cloneNode(true);
            const newSelect = newRow.querySelector(".part-select");
            const newQty = newRow.querySelector(".part-qty");

            newSelect.value = "0";
            newQty.value = 1;
            newQty.disabled = true;
            newQty.removeAttribute("max");

            container.appendChild(newRow);
        }
    } else {
        qtyInput.disabled = true;
        qtyInput.value = 1;
        qtyInput.removeAttribute("max");
    }

    updateDisabledOptions(container);
    calculateTotal();
}

function updateDisabledOptions(container) {
    const selects = container.querySelectorAll(".part-select");
    const selectedValues = Array.from(selects).map(s => s.value).filter(v => v !== "0");

    selects.forEach(select => {
        Array.from(select.options).forEach(option => {
            if (option.value === "0") return;

            const stock = parseInt(option.dataset.stock || 0, 10);
            if (stock <= 0) {
                option.disabled = true;
                return;
            }

            option.disabled = selectedValues.includes(option.value) && option.value !== select.value;
        });
    });
}

function calculateTotal() {
    let total = 0;

    document.querySelectorAll(".part-row").forEach(row => {
        const select = row.querySelector(".part-select");
        const qty = row.querySelector(".part-qty");
        const selectedOption = select.options[select.selectedIndex];

        if (select.value !== "0" && !qty.disabled) {
            const max = parseInt(qty.max || 1, 10);
            const price = parseFloat(selectedOption.dataset.price || 0);

            if (parseInt(qty.value || 0, 10) > max) {
                qty.value = max;
            }

            total += price * parseInt(qty.value || 1, 10);
        }
    });

    document.getElementById("total").innerText = total.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function collectBuildItems() {
    const selectedItems = [];

    document.querySelectorAll(".part-row").forEach(row => {
        const select = row.querySelector(".part-select");
        const qtyInput = row.querySelector(".part-qty");

        if (select.value !== "0" && !qtyInput.disabled) {
            const quantity = parseInt(qtyInput.value || 0, 10);
            const productId = parseInt(select.value, 10);
            if (productId > 0 && quantity > 0) {
                selectedItems.push({ product_id: productId, quantity: quantity });
            }
        }
    });

    return selectedItems;
}

function applyPrefill(items) {
    if (!Array.isArray(items) || !items.length) {
        return;
    }

    items.forEach(item => {
        const productId = String(item.product_id || 0);
        const requestedQty = parseInt(item.quantity || 1, 10);
        if (productId === "0") {
            return;
        }

        const containers = document.querySelectorAll(".part-container");
        let targetContainer = null;

        for (const container of containers) {
            const firstSelect = container.querySelector(".part-select");
            if (!firstSelect) {
                continue;
            }

            const hasOption = Array.from(firstSelect.options).some(option => option.value === productId);
            if (hasOption) {
                targetContainer = container;
                break;
            }
        }

        if (!targetContainer) {
            return;
        }

        const rows = targetContainer.querySelectorAll(".part-row");
        const targetRow = rows[rows.length - 1];
        const select = targetRow.querySelector(".part-select");
        const qtyInput = targetRow.querySelector(".part-qty");
        select.value = productId;
        handleSelect(select);

        const selectedOption = select.options[select.selectedIndex];
        const stock = parseInt(selectedOption.dataset.stock || 0, 10);
        const maxAllowed = stock > 0 ? stock : 1;
        const safeQty = Math.max(1, Math.min(requestedQty, maxAllowed));

        if (!qtyInput.disabled) {
            qtyInput.value = safeQty;
        }
    });

    calculateTotal();
}

applyPrefill(prefillBuildItems);

document.querySelector('form[action*="checkout"]').addEventListener("submit", function () {
    const selectedItems = collectBuildItems();
    document.getElementById("build-items-input").value = JSON.stringify(selectedItems);
});
</script>
</body>
</html>

<script>
// Confirm before logging out
(function(){
    try{
        var logoutUrl = "{% url 'logout' %}";
        document.addEventListener('click', function(e){
            var a = e.target.closest && e.target.closest('a');
            if(!a) return;
            var href = a.getAttribute('href');
            if(!href) return;
            if(href === logoutUrl){
                e.preventDefault();
                if(confirm('Are you sure you want to log out?')){
                    window.location.href = logoutUrl;
                }
            }
        });
    }catch(err){console && console.error && console.error(err)}
})();
</script>



